# 手动修复指南

如果在运行测试时遇到 `'NoneType' object has no attribute 'shape'` 错误，这很可能是因为在动态原型模式下 `frm_scr` 变量未定义。以下是手动修复步骤：

## 方法1: 使用修复脚本

运行提供的修复脚本：
```bash
python fix_frm_scr.py
```

这个脚本会自动寻找并修复问题代码。

## 方法2: 手动编辑model.py

如果脚本不起作用，可以按照以下步骤手动修改：

1. 打开`model.py`文件
2. 找到PredictionModule方法中的动态原型分支代码（大约在第542-551行）
3. 在代码:
```python
if use_dynamic_prototype and context_vector is not None:
    # 使用动态原型进行视频级分类
    B = context_vector.size(0)
    ca_vid_scr = torch.zeros((B, self.num_classes + 1)).to(x.device)
    cw_vid_scr = torch.zeros((B, self.num_classes + 1)).to(x.device)
    
    for b in range(B):
        ca_vid_scr[b] = torch.einsum('d,cd->c', [norms_ca_vid_feat[b], dynamic_prototypes_norm[b]]) * 20.
        cw_vid_scr[b] = torch.einsum('cd,cd->c', [norms_cw_vid_feat[b], dynamic_prototypes_norm[b]]) * 20.
```

4. 在这个代码块的末尾（在`else:`之前）添加以下代码：
```python
    # 动态原型模式下，明确指定frm_scr
    frm_scr = frm_scrs
```

5. 保存文件并重新运行测试

## 方法3: 修改返回前的检查

另一种解决方法是修改return语句之前的检查代码。找到类似这样的代码：
```python
# 确保frm_scr在所有条件分支中都有定义
if use_dynamic_prototype and context_vector is not None and 'frm_scr' not in locals():
    frm_scr = frm_scrs
```

并将其修改为：
```python
# 确保frm_scr在所有条件分支中都有定义
if use_dynamic_prototype and context_vector is not None:
    if 'frm_scr' not in locals() or frm_scr is None:
        frm_scr = frm_scrs
```

这将确保即使frm_scr已经在locals()中但值为None，也会被赋予正确的值。

## 完整版修复

为了完全解决问题，建议同时实施方法2和方法3，这样即使在不同的执行路径下也能保证frm_scr是有效的张量。

如果在执行上述修复后仍然遇到问题，可能需要检查model.py中其他可能影响frm_scr变量的代码部分。

